<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ИЛХО Viewer</title>
  <link rel="icon" type="image/png" href="/static/img.png"/>
  <link rel="stylesheet" href="/static/style.css?v={{asset_v}}"/>
  <!-- Plotly через CDN (если интернет закрыт — скажи, сделаю офлайн-версию с локальным plotly.js) -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1><img src="/static/img.png" alt="" class="header-logo">ИЛХО Viewer</h1>
    </header>

    <section class="panel">
      <div class="row topRow">
        <label>Папка теста:</label>
        <input id="folder" type="text" placeholder="Например: C:\\Tests\\...\\Test-05" />
        <button id="btnPick">Обзор…</button>
        <button id="btnLoad">Загрузить</button>
        <select id="recentFolders" class="recentSel" title="Недавние папки"></select>
        <button id="btnCopyFolder" type="button" class="btnMini" title="Скопировать путь">Копировать</button>
        <button id="btnClearRecent" type="button" class="btnMini" title="Очистить недавние">Очистить</button>
      </div>

      <div class="box summaryWide">
        <div class="boxTitle">Сводка</div>
        <div id="summary">Не загружено</div>
      </div>

      <div class="main3">
        <!-- 1) Органы управления каналами / сортировкой / наборами -->
        <div class="box controlsBox">
          <div class="boxTitle">Управление каналами</div>
          <div class="boxContent" id="channelControls">

            <div class="chanToolbar">
              <div class="btnRow2">
                <button id="btnAll" type="button" data-hint="Выбрать все каналы в текущем списке.">Выбрать все</button>
                <button id="btnNone" type="button" data-hint="Снять выбор со всех каналов, но оставить выбранным самый первый в списке.">Снять все</button>
              </div>
              <div class="sortRow">
                <label for="sortMode" data-hint="Меняет порядок каналов в списке и в экспорте (CSV/Excel/шаблон).">Сортировка:</label>
                <select id="sortMode" data-hint="Как упорядочить каналы: как в файле, человекоудобно, по названию и т.д.">
                  <option value="file" selected>Как в файле</option>
                  <option value="custom">Мой порядок (сохранённый)</option>
                  <option value="priority">Приоритет + человекоудобно</option>
                  <option value="natural">Человекоудобно по коду</option>
                  <option value="label">По названию</option>
                  <option value="unit">По единицам, затем код</option>
                </select>
              </div>
            </div>

            <div class="filterToolbar simpleFilter">
              <input id="chanSearch" type="text" placeholder="Поиск каналов (код/название/ед.)…" data-hint="Фильтр списка каналов по коду, названию или единицам.&#10;Esc — очистить поиск." />
              <label class="check" data-hint="Компактный режим: меньше отступы и выше плотность списка.">
                <input id="viewCompact" type="checkbox"/> компактно
              </label>
            </div>

            <div class="orderToolbar" data-hint="Сохранение порядка относится к режиму «Мой порядок (сохранённый)».">
              <div class="rowLine">
                <input id="orderName" type="text" placeholder="Имя порядка (для сохранения)…" data-hint="Введи имя и нажми «Сохранить», чтобы записать текущий порядок каналов."/>
                <button id="btnSaveNamed" type="button" data-hint="Сохранить текущий порядок каналов под указанным именем.">Сохранить</button>
              </div>
              <div class="rowLine">
                <select id="orderSelect" title="Сохранённые порядки" data-hint="Выбери сохранённый порядок из списка."></select>
                <button id="btnLoadNamed" type="button" data-hint="Применить выбранный сохранённый порядок.">Загрузить</button>
                <button id="btnRefreshOrders" type="button" data-hint="Обновить список сохранённых порядков (из папки saved_orders).">Обновить</button>
              </div>
            </div>

            <div class="controlsHints" id="controlsHints">
              <div class="controlsHintsTitle">Подсказки</div>
              <div class="controlsHintsBody" id="controlsHintsBody" data-default="Наведи мышь на любой элемент в этом блоке — здесь появится подсказка.">Наведи мышь на любой элемент в этом блоке — здесь появится подсказка.</div>
            </div>

            <div class="excel-tips">
              <div class="excel-tips-title">Подсказка по Excel:</div>
              <p>После выгрузки в шаблон необходимо включить автоматический расчет формул:</p>
              <ol class="excel-tips-list">
                <li class="excel-tips-item">Перейдите на вкладку "Формулы"</li>
                <li class="excel-tips-item">Выберите "Параметры вычисления" → "Автоматически"</li>
              </ol>
            </div>

          </div>
        </div>

        <!-- 2) Список каналов -->
        <div class="box listBox">
          <div class="boxTitle">Список каналов</div>
          <div class="boxContent listContent">
            <ul id="channelList" class="chanList" tabindex="0"></ul>
          </div>
          <div class="hint">Выбор как в Windows: клик — выбрать, Ctrl+клик — добавить/убрать, Shift+клик — диапазон. Двойной клик — оставить только этот канал.</div>
        </div>

        <!-- 3) Диапазон / Экспорт -->
        <div class="box exportBox">
          <div class="boxTitle">Диапазон / Экспорт</div>
          <div class="boxContent">
            <div class="stylePanel">
            <div class="styleTitle">Оформление экспорта (шаблон XLSX)</div>

            <div class="row2 colorFmtRow">
              <label>Формат цвета:</label>
              <select id="colorFormat" title="Как показывать подпись под цветом">
                <option value="hex" selected>HEX</option>
                <option value="rgb">RGB</option>
              </select>
              <span class="mini">подпись под каждым цветом</span>
            </div>

            <div class="row2">
              <label>Если мощность &lt;</label>
              <input id="rmThreshold" type="number" step="0.1" style="width:90px"/>
              <label>цвет:</label>
              <div class="colorStack">
                <input id="rmColor" type="color"/>
                <input id="rmColorCode" type="text" class="clrCodeInput" autocomplete="off" spellcheck="false"/>
              </div>
            </div>

            <div class="scaleGrid">

              <div class="scaleRow">
                <div class="scaleName">min t в объёме</div>
                <div class="scaleNorm">
                  <span class="sg">норма от</span>
                  <input id="wMin" type="number" step="0.1" title="Нижняя граница нормы"/>
                  <span class="sg">до</span>
                  <input id="wOpt" type="number" step="0.1" title="Верхняя граница нормы"/>
                </div>
                <div class="scaleColors">
                  <div class="scaleColorGroup"><span class="sg">низк.</span><input id="wCMin" type="color" title="Цвет: ниже нормы"/></div>
                  <div class="scaleColorGroup"><span class="sg">норма</span><input id="wCOpt" type="color" title="Цвет: в норме"/></div>
                  <div class="scaleColorGroup"><span class="sg">высок.</span><input id="wCMax" type="color" title="Цвет: выше нормы"/></div>
                </div>
              </div>

              <div class="scaleRow">
                <div class="scaleName">max t в объёме</div>
                <div class="scaleNorm">
                  <span class="sg">норма от</span>
                  <input id="xMin" type="number" step="0.1" title="Нижняя граница нормы"/>
                  <span class="sg">до</span>
                  <input id="xOpt" type="number" step="0.1" title="Верхняя граница нормы"/>
                </div>
                <div class="scaleColors">
                  <div class="scaleColorGroup"><span class="sg">низк.</span><input id="xCMin" type="color" title="Цвет: ниже нормы"/></div>
                  <div class="scaleColorGroup"><span class="sg">норма</span><input id="xCOpt" type="color" title="Цвет: в норме"/></div>
                  <div class="scaleColorGroup"><span class="sg">высок.</span><input id="xCMax" type="color" title="Цвет: выше нормы"/></div>
                </div>
              </div>

              <div class="scaleRow">
                <div class="scaleName">сред t в объёме</div>
                <div class="scaleNorm">
                  <span class="sg">норма от</span>
                  <input id="yMin" type="number" step="0.1" title="Нижняя граница нормы"/>
                  <span class="sg">до</span>
                  <input id="yOpt" type="number" step="0.1" title="Верхняя граница нормы"/>
                </div>
                <div class="scaleColors">
                  <div class="scaleColorGroup"><span class="sg">низк.</span><input id="yCMin" type="color" title="Цвет: ниже нормы"/></div>
                  <div class="scaleColorGroup"><span class="sg">норма</span><input id="yCOpt" type="color" title="Цвет: в норме"/></div>
                  <div class="scaleColorGroup"><span class="sg">высок.</span><input id="yCMax" type="color" title="Цвет: выше нормы"/></div>
                </div>
              </div>

            </div>

            <div class="row2">
              <button id="btnSaveStyle" type="button">Применить</button>
              <span id="styleStatus" class="statusText"></span>
            </div>

            <span class="qmark" title="Эти настройки сохраняются в viewer_settings.json и применяются к следующей выгрузке «В шаблон XLSX». min/max/сред t в объёме задаются независимо: укажи «нормальный диапазон» (min..opt). Ниже min — цвет «низк.», в диапазоне min..opt (включая границы) — цвет «норма», выше opt — цвет «высок.»">?</span>
          </div>

          <div class="row2 stepRow">
            <label>Шаг:</label>
            <label class="check"><input id="stepAuto" type="checkbox" checked/> Авто</label>
            <select id="stepTarget" title="Целевое количество точек (примерно) для авто-шага">
              <option value="5000" selected>≈ 5k точек</option>
              <option value="10000">≈ 10k точек</option>
              <option value="20000">≈ 20k точек</option>
            </select>
            <input id="step" type="number" min="1" value="1" style="width:80px"
                   title="Прореживание данных: 1 — каждый замер; 2 — каждый второй; 10 — каждый десятый. Чем больше N, тем быстрее график и меньше размер экспорта, но ниже детализация."/>
            <span id="stepAutoInfo" class="mini"></span>
            <span class="qmark" title="Прореживание данных: 1 — каждый замер; 2 — каждый второй; 10 — каждый десятый. Чем больше N, тем быстрее график и меньше размер экспорта, но ниже детализация.">?</span>
          </div>
          <div class="helpText">
            Авто-режим подбирает шаг так, чтобы точек было примерно как в выбранной цели. Вручную: 1 — все точки, 2 — каждая 2-я и т.д.
          </div>

          <div class="row2">
            <label class="check"><input id="showLegend" type="checkbox" checked/> Легенда</label>
             <label class="check"><input id="tplExtra" type="checkbox" checked/> доп. каналы (Z…)</label>
            <span id="tplStatus" class="statusText"></span>
          </div>

          <div class="exportOptRow">

          </div>

          <div id="exportInfo" class="exportInfo">—</div>

          <div class="row2">
            <div class="rangeLine"><b>Выбранный интервал:</b> <span id="rangeText">—</span></div>
          </div>



          <div class="hint">
            Интервал экспорта берётся из видимой области графика по оси X.
            Увеличь/уменьши масштаб (выделением мышью или колесом). Текущий интервал покажу справа. Также можно двигать range-slider снизу.
          </div>

          <div class="exportBottomBar">
            <button id="btnTpl" type="button">В шаблон XLSX</button>
          </div>
          </div>
        </div>
      </div>
    </section>

    <section class="plotPanel">
      <div class="plotTitle">График</div>
      <div class="plotSub">Подсказка: двойной клик по легенде — оставить только одну линию. Один клик — скрыть/показать линию.</div>
      <div id="plot" class="plot"></div>
    </section>

    <section class="logPanel">
      <div class="boxTitle">Лог</div>
      <pre id="log"></pre>
    </section>
  </div>

  <!-- Busy overlay + toasts -->
  <div id="busyOverlay" class="overlay hidden" aria-hidden="true">
    <div class="overlayBox">
      <div class="spinnerLarge"></div>
      <div class="overlayTextWrap">
        <div id="busyText" class="overlayText">Работаю…</div>
        <div id="busyTimer" class="overlayTimer"></div>
      </div>
    </div>
  </div>
  <div id="toastContainer" class="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <div class="copyright">© ТОО "Jasyl Suyq Qazaqstan"</div>
  <script src="/static/app.js?v={{asset_v}}"></script>
</body>
</html>
