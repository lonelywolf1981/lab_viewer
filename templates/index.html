<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ИЛХО Viewer</title>
  <link rel="stylesheet" href="/static/style.css?v={{asset_v}}"/>
  <!-- Plotly через CDN (если интернет закрыт — скажи, сделаю офлайн-версию с локальным plotly.js) -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ИЛХО Viewer</h1>
      <div class="sub">Локальный просмотрщик Prova*.dbf. Порт: {{port}}</div>
    </header>

    <section class="panel">
      <div class="row topRow">
        <label>Папка теста:</label>
        <input id="folder" type="text" placeholder="Например: C:\\Tests\\...\\Test-05" />
        <button id="btnPick">Обзор…</button>
        <button id="btnLoad">Загрузить</button>
        <select id="recentFolders" class="recentSel" title="Недавние папки"></select>
        <button id="btnCopyFolder" type="button" class="btnMini" title="Скопировать путь">Копировать</button>
        <button id="btnClearRecent" type="button" class="btnMini" title="Очистить недавние">Очистить</button>
      </div>

      <div class="box summaryWide">
        <div class="boxTitle">Сводка</div>
        <div id="summary">Не загружено</div>
      </div>

      <div class="main3">
        <!-- 1) Органы управления каналами / сортировкой / наборами -->
        <div class="box controlsBox">
          <div class="boxTitle">Управление каналами</div>
          <div class="boxContent">
            <div class="chanToolbar">
  <div class="btnRow2">
    <button id="btnAll" type="button">Выбрать все</button>
    <button id="btnNone" type="button">Снять все</button>
  </div>
  <div class="sortRow">
    <label for="sortMode">Сортировка:</label>
    <select id="sortMode">
                  <option value="file" selected>Как в файле</option>
                  <option value="custom">Мой порядок (сохранённый)</option>
                  <option value="priority">Приоритет + человекоудобно</option>
                  <option value="natural">Человекоудобно по коду</option>
                  <option value="label">По названию</option>
                  <option value="unit">По единицам, затем код</option>
                </select>
  </div>
</div>

            <div class="filterToolbar">
              <input id="chanSearch" type="text" placeholder="Поиск каналов (код/название/ед.)…" />
              <label class="check"><input id="onlySelected" type="checkbox"/> только выбранные</label>
              <label class="check"><input id="viewCompact" type="checkbox"/> компактно</label>
              <label class="check"><input id="viewGroups" type="checkbox"/> группы</label>
              <span id="selCount" class="miniBadge">Выбрано: 0</span>
            </div>

            <div class="chipRow" id="chipRow">
              <button class="chip" type="button" data-ftype="prefix" data-fval="B-">B-*</button>
              <button class="chip" type="button" data-ftype="prefix" data-fval="C-">C-*</button>
              <button class="chip" type="button" data-ftype="prefix" data-fval="UR-">UR-*</button>
              <button class="chip" type="button" data-ftype="prefix" data-fval="T-">T-*</button>
              <span class="chipSep"></span>
              <button class="chip" type="button" data-ftype="unit" data-fval="°C">°C</button>
              <button class="chip" type="button" data-ftype="unit" data-fval="bar">bar</button>
              <button class="chip" type="button" data-ftype="unit" data-fval="%">%</button>
              <button class="chip" type="button" data-ftype="unit" data-fval="W">W</button>
              <button class="chip" type="button" data-ftype="unit" data-fval="V">V</button>
              <button class="chip chipClear" type="button" id="btnClearFilter">Сброс</button>
            </div>

            <div class="orderToolbar">
  <div class="rowLine">
    <input id="orderName" type="text" placeholder="Имя порядка (для сохранения)…"/>
    <button id="btnSaveNamed" type="button">Сохранить</button>
  </div>
  <div class="rowLine">
    <select id="orderSelect" title="Сохранённые порядки"></select>
    <button id="btnLoadNamed" type="button">Загрузить</button>
    <button id="btnRefreshOrders" type="button">Обновить</button>
  </div>
</div>

            <div class="presetToolbar">
  <div class="rowLine">
    <input id="presetName" type="text" placeholder="Имя набора (каналы + настройки)…"/>
    <button id="btnSavePreset" type="button">Сохранить набор</button>
  </div>
  <div class="rowLine">
    <select id="presetSelect" title="Сохранённые наборы"></select>
  </div>
  <div class="btnRow3">
    <button id="btnLoadPreset" type="button">Применить</button>
    <button id="btnRefreshPresets" type="button">Обновить</button>
    <button id="btnDeletePreset" type="button">Удалить</button>
  </div>
</div>

            <div class="hint mini">Набор сохраняет: выбранные каналы, шаг, легенду и (при необходимости) порядок/сортировку.</div>
          </div>
        </div>

        <!-- 2) Список каналов -->
        <div class="box listBox">
          <div class="boxTitle">Список каналов</div>
          <div class="boxContent listContent">
            <ul id="channelList" class="chanList" tabindex="0"></ul>
          </div>
          <div class="hint">Выбор как в Windows: клик — выбрать, Ctrl+клик — добавить/убрать, Shift+клик — диапазон. Двойной клик — оставить только этот канал.</div>
        </div>

        <!-- 3) Диапазон / Экспорт -->
        <div class="box exportBox">
          <div class="boxTitle">Диапазон / Экспорт</div>
          <div class="boxContent">

          <div class="row2 stepRow">
            <label>Шаг:</label>
            <label class="check"><input id="stepAuto" type="checkbox" checked/> Авто</label>
            <select id="stepTarget" title="Целевое количество точек (примерно) для авто-шага">
              <option value="5000" selected>≈ 5k точек</option>
              <option value="10000">≈ 10k точек</option>
              <option value="20000">≈ 20k точек</option>
            </select>
            <input id="step" type="number" min="1" value="1" style="width:80px"
                   title="Прореживание данных: 1 — каждый замер; 2 — каждый второй; 10 — каждый десятый. Чем больше N, тем быстрее график и меньше размер экспорта, но ниже детализация."/>
            <span id="stepAutoInfo" class="mini"></span>
            <span class="qmark" title="Прореживание данных: 1 — каждый замер; 2 — каждый второй; 10 — каждый десятый. Чем больше N, тем быстрее график и меньше размер экспорта, но ниже детализация.">?</span>
          </div>
          <div class="helpText">
            Авто-режим подбирает шаг так, чтобы точек было примерно как в выбранной цели. Вручную: 1 — все точки, 2 — каждая 2-я и т.д.
          </div>

          <div class="row2">
            <label class="check"><input id="showLegend" type="checkbox" checked/> Легенда</label>
          </div>

          <div class="exportBtnRow">
  <button id="btnCsv">Экспорт CSV</button>
  <button id="btnXlsx">Экспорт Excel</button>
  <button id="btnTpl">В шаблон XLSX</button>
</div>

<div class="exportOptRow">
  <label class="check"><input id="tplExtra" type="checkbox" checked/> доп. каналы (Z…)</label>
  <span id="tplStatus" class="statusText"></span>
</div>

          <div id="exportInfo" class="exportInfo">—</div>

          <div class="row2">
            <div class="rangeLine"><b>Выбранный интервал:</b> <span id="rangeText">—</span></div>
          </div>

          <div class="stylePanel">
            <div class="styleTitle">Оформление экспорта (шаблон XLSX)</div>

            <div class="row2 colorFmtRow">
              <label>Формат цвета:</label>
              <select id="colorFormat" title="Как показывать подпись под цветом">
                <option value="hex" selected>HEX</option>
                <option value="rgb">RGB</option>
              </select>
              <span class="mini">подпись под каждым цветом</span>
            </div>

            <div class="row2">
              <label>Строки B..P, если T &lt;</label>
              <input id="rmThreshold" type="number" step="0.1" style="width:90px"/>
              <label>цвет:</label>
              <input id="rmColor" type="color"/>
            </div>

            <div class="row2">
              <label>Интенсивность:</label>
              <input id="rmIntensity" type="range" min="0" max="100" value="100"/>
              <span id="rmIntensityVal" class="mini">100</span>
            </div>

            <div class="scaleGrid">
              <div class="scaleRow">
                <div class="scaleName">W</div>
                <div class="scaleGroup">
                  <span class="sgLabel">min</span>
                  <input id="wMin" type="number" step="0.1"/>
                  <input id="wCMin" type="color" title="Цвет min"/>
                </div>
                <div class="scaleGroup">
                  <span class="sgLabel">opt</span>
                  <input id="wOpt" type="number" step="0.1"/>
                  <input id="wCOpt" type="color" title="Цвет opt"/>
                </div>
                <div class="scaleGroup">
                  <span class="sgLabel">max</span>
                  <input id="wMax" type="number" step="0.1"/>
                  <input id="wCMax" type="color" title="Цвет max"/>
                </div>
              </div>

              <div class="scaleRow">
                <div class="scaleName">X</div>
                <div class="scaleGroup">
                  <span class="sgLabel">min</span>
                  <input id="xMin" type="number" step="0.1"/>
                  <input id="xCMin" type="color" title="Цвет min"/>
                </div>
                <div class="scaleGroup">
                  <span class="sgLabel">opt</span>
                  <input id="xOpt" type="number" step="0.1"/>
                  <input id="xCOpt" type="color" title="Цвет opt"/>
                </div>
                <div class="scaleGroup">
                  <span class="sgLabel">max</span>
                  <input id="xMax" type="number" step="0.1"/>
                  <input id="xCMax" type="color" title="Цвет max"/>
                </div>
              </div>

              <div class="scaleRow">
                <div class="scaleName">Y</div>
                <div class="scaleGroup">
                  <span class="sgLabel">min</span>
                  <input id="yMin" type="number" step="0.1"/>
                  <input id="yCMin" type="color" title="Цвет min"/>
                </div>
                <div class="scaleGroup">
                  <span class="sgLabel">opt</span>
                  <input id="yOpt" type="number" step="0.1"/>
                  <input id="yCOpt" type="color" title="Цвет opt"/>
                </div>
                <div class="scaleGroup">
                  <span class="sgLabel">max</span>
                  <input id="yMax" type="number" step="0.1"/>
                  <input id="yCMax" type="color" title="Цвет max"/>
                </div>
              </div>
            </div>

            <div class="row2">
              <button id="btnSaveStyle" type="button">Применить</button>
              <span id="styleStatus" class="statusText"></span>
            </div>

            <div class="hint mini">
              Эти настройки сохраняются в viewer_settings.json и применяются к следующей выгрузке «В шаблон XLSX».
              W/X/Y независимы от других ячеек: используется порог opt. Ниже opt — цвет min, равно opt — цвет opt, выше opt — цвет max.
            </div>
          </div>

          <div class="hint">
            Интервал экспорта берётся из видимой области графика по оси X.
            Увеличь/уменьши масштаб (выделением мышью или колесом). Текущий интервал покажу справа. Также можно двигать range-slider снизу.
          </div>
          </div>
        </div>
      </div>
    </section>

    <section class="plotPanel">
      <div class="plotTitle">График</div>
      <div class="plotSub">Подсказка: двойной клик по легенде — оставить только одну линию. Один клик — скрыть/показать линию.</div>
      <div id="plot" class="plot"></div>
    </section>

    <section class="logPanel">
      <div class="boxTitle">Лог</div>
      <pre id="log"></pre>
    </section>
  </div>

  <!-- Busy overlay + toasts -->
  <div id="busyOverlay" class="overlay hidden" aria-hidden="true">
    <div class="overlayBox">
      <div class="spinnerLarge"></div>
      <div id="busyText" class="overlayText">Работаю…</div>
    </div>
  </div>
  <div id="toastContainer" class="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <script src="/static/app.js?v={{asset_v}}"></script>
</body>
</html>
